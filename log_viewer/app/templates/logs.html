<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Logs Viewer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">
                <i class="fas fa-list-alt mr-2"></i>
                Logs Viewer
            </h1>
            <div class="flex space-x-4">
                <a href="/" class="hover:bg-blue-700 px-3 py-2 rounded transition">Dashboard</a>
                <a href="/logs" class="hover:bg-blue-700 px-3 py-2 rounded transition bg-blue-700">Logs</a>
                <button onclick="exportLogs()" class="hover:bg-blue-700 px-3 py-2 rounded transition">
                    <i class="fas fa-download mr-1"></i>
                    Export
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">
                <i class="fas fa-filter mr-2 text-blue-600"></i>
                Filters
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <!-- Log Level Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Level</label>
                    <select id="level-filter" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Levels</option>
                        <option value="DEBUG">Debug</option>
                        <option value="INFO">Info</option>
                        <option value="WARNING">Warning</option>
                        <option value="ERROR">Error</option>
                        <option value="CRITICAL">Critical</option>
                    </select>
                </div>

                <!-- Time Range -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Time Range</label>
                    <select id="hours-filter" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="1">Last Hour</option>
                        <option value="6">Last 6 Hours</option>
                        <option value="24" selected>Last 24 Hours</option>
                        <option value="72">Last 3 Days</option>
                        <option value="168">Last Week</option>
                    </select>
                </div>

                <!-- User ID Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">User ID</label>
                    <input type="number" id="user-filter" placeholder="Enter User ID" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Action Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Action</label>
                    <input type="text" id="action-filter" placeholder="Action name" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Search -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <input type="text" id="search-filter" placeholder="Search in logs" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Limit -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Limit</label>
                    <select id="limit-filter" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="250">250</option>
                        <option value="500">500</option>
                        <option value="1000">1000</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-between items-center mt-4">
                <button onclick="applyFilters()" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
                    <i class="fas fa-search mr-2"></i>
                    Apply Filters
                </button>
                
                <button onclick="clearFilters()" 
                        class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition">
                    <i class="fas fa-times mr-2"></i>
                    Clear All
                </button>
            </div>
        </div>

        <!-- Logs Display -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-list mr-2 text-green-600"></i>
                        Logs <span id="logs-count" class="text-sm text-gray-500">(0)</span>
                    </h3>
                    
                    <div class="flex space-x-2">
                        <button onclick="refreshLogs()" 
                                class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition">
                            <i class="fas fa-sync-alt mr-1"></i>
                            Refresh
                        </button>
                        
                        <button onclick="toggleAutoRefresh()" id="auto-refresh-btn"
                                class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 transition">
                            <i class="fas fa-play mr-1"></i>
                            Auto Refresh
                        </button>
                    </div>
                </div>
            </div>

            <div id="logs-container" class="max-h-screen overflow-y-auto">
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading logs...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Detail Modal -->
    <div id="log-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-800">Log Details</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div id="log-modal-content" class="p-6">
                    <!-- Modal content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let currentFilters = {};

        // Apply filters and load logs
        async function applyFilters() {
            const filters = {
                level: document.getElementById('level-filter').value,
                hours: parseInt(document.getElementById('hours-filter').value),
                user_id: document.getElementById('user-filter').value ? parseInt(document.getElementById('user-filter').value) : null,
                action: document.getElementById('action-filter').value,
                search: document.getElementById('search-filter').value,
                limit: parseInt(document.getElementById('limit-filter').value)
            };

            currentFilters = filters;
            await loadLogs(filters);
        }

        // Load logs from API
        async function loadLogs(filters = {}) {
            try {
                const container = document.getElementById('logs-container');
                container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Loading logs...</p></div>';

                const params = new URLSearchParams();
                Object.entries(filters).forEach(([key, value]) => {
                    if (value !== null && value !== '') {
                        params.append(key, value);
                    }
                });

                const response = await fetch(`/api/logs?${params}`);
                const data = await response.json();

                document.getElementById('logs-count').textContent = `(${data.logs.length})`;

                if (data.logs.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-search text-2xl mb-2"></i><p>No logs found with current filters</p></div>';
                    return;
                }

                const logsHtml = data.logs.map(log => createLogEntry(log)).join('');
                container.innerHTML = logsHtml;

            } catch (error) {
                console.error('Failed to load logs:', error);
                document.getElementById('logs-container').innerHTML = 
                    '<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-triangle text-2xl mb-2"></i><p>Failed to load logs</p></div>';
            }
        }

        // Create HTML for a single log entry
        function createLogEntry(log) {
            const levelColors = {
                'DEBUG': 'bg-gray-100 text-gray-800 border-l-gray-400',
                'INFO': 'bg-blue-50 text-blue-900 border-l-blue-400',
                'WARNING': 'bg-yellow-50 text-yellow-900 border-l-yellow-400',
                'ERROR': 'bg-red-50 text-red-900 border-l-red-500',
                'CRITICAL': 'bg-purple-50 text-purple-900 border-l-purple-500'
            };

            const levelIcons = {
                'DEBUG': 'fas fa-bug',
                'INFO': 'fas fa-info-circle',
                'WARNING': 'fas fa-exclamation-triangle',
                'ERROR': 'fas fa-times-circle',
                'CRITICAL': 'fas fa-skull-crossbones'
            };

            const colorClass = levelColors[log.level] || 'bg-gray-100 text-gray-800 border-l-gray-400';
            const iconClass = levelIcons[log.level] || 'fas fa-circle';
            const timestamp = new Date(log.timestamp).toLocaleString();

            return `
                <div class="border-l-4 ${colorClass} p-4 border-b border-gray-100 hover:bg-opacity-75 transition cursor-pointer" 
                     onclick="showLogDetails('${log.timestamp}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <i class="${iconClass} mr-2"></i>
                                <span class="font-semibold text-sm">${log.level}</span>
                                <span class="mx-2">•</span>
                                <span class="text-sm">${timestamp}</span>
                                ${log.execution_time ? `<span class="mx-2">•</span><span class="text-sm">${log.execution_time}s</span>` : ''}
                            </div>
                            
                            <p class="text-sm font-medium mb-1">${escapeHtml(log.message || 'No message')}</p>
                            
                            <div class="text-xs opacity-75">
                                ${log.user_id ? `<span class="mr-4"><i class="fas fa-user mr-1"></i>User: ${log.user_id}</span>` : ''}
                                ${log.action ? `<span class="mr-4"><i class="fas fa-cog mr-1"></i>${log.action}</span>` : ''}
                                <span class="mr-4"><i class="fas fa-code mr-1"></i>${log.function}:${log.line}</span>
                                <span><i class="fas fa-layer-group mr-1"></i>${log.module}</span>
                            </div>
                        </div>
                        
                        <button class="text-gray-400 hover:text-gray-600 ml-4" onclick="event.stopPropagation(); showLogDetails('${log.timestamp}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        // Show detailed log information in modal
        function showLogDetails(timestamp) {
            // Find the log entry
            // For demo purposes, we'll create a simple modal
            // In a real implementation, you might want to fetch full details from API
            const modal = document.getElementById('log-modal');
            const content = document.getElementById('log-modal-content');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <p class="text-sm text-gray-500">Timestamp: ${timestamp}</p>
                    <p class="text-sm">This would show full log details, stack traces, and additional context.</p>
                    <p class="text-sm text-gray-500">Feature can be extended to show full JSON log entry, formatted stack traces, related logs, etc.</p>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('log-modal').classList.add('hidden');
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('level-filter').value = '';
            document.getElementById('hours-filter').value = '24';
            document.getElementById('user-filter').value = '';
            document.getElementById('action-filter').value = '';
            document.getElementById('search-filter').value = '';
            document.getElementById('limit-filter').value = '100';
        }

        // Refresh logs with current filters
        function refreshLogs() {
            loadLogs(currentFilters);
        }

        // Toggle auto-refresh
        function toggleAutoRefresh() {
            const btn = document.getElementById('auto-refresh-btn');
            
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                btn.innerHTML = '<i class="fas fa-play mr-1"></i>Auto Refresh';
                btn.className = 'bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700 transition';
            } else {
                autoRefreshInterval = setInterval(() => refreshLogs(), 5000); // Refresh every 5 seconds
                btn.innerHTML = '<i class="fas fa-stop mr-1"></i>Stop Auto';
                btn.className = 'bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition';
            }
        }

        // Export logs
        function exportLogs() {
            const params = new URLSearchParams();
            Object.entries(currentFilters).forEach(([key, value]) => {
                if (value !== null && value !== '') {
                    params.append(key, value);
                }
            });
            
            window.open(`/api/download/bot_structured.log?${params}`, '_blank');
        }

        // Utility function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            applyFilters(); // Load initial logs
        });

        // Close modal when clicking outside
        document.getElementById('log-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>