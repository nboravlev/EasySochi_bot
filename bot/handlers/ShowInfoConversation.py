from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import (
    ContextTypes, ConversationHandler, CommandHandler,
    CallbackQueryHandler, MessageHandler, filters
)
from utils.message_tricks import add_message_to_cleanup, cleanup_messages, send_message
from handlers.ReferralLinkConversation import start_invite
from handlers.UserSendProblemConversation import start_problem

from telegram.error import BadRequest #–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–º–µ–Ω–∞ –º–æ–µ–º—É –ª–æ–≥–≥–µ—Ä—É
import logging   #–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–º–µ–Ω–∞ –º–æ–µ–º—É –ª–æ–≥–≥–µ—Ä—É
import os



INFO_TEXTS = {
    "info_booking": {
        "title": "üìÜ *–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é:*",
        "body": (
            "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª <b>–•–æ—á—É —Å–Ω—è—Ç—å –∂–∏–ª—å—ë</b>;\n"
            "2. –°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º —Ä–æ–±–æ—Ç–∞;\n"
            "3. –ù–∞–π–¥–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –æ–±—ä–µ–∫—Ç —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫;\n"
            "4. –ù–∞–∂–º–∏—Ç–µ <b>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</b>;\n"
            "5. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞;\n"
            "6. –û–±—â–∞–π—Ç–µ—Å—å —Å –Ω–∏–º –≤ —á–∞—Ç–µ –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é;\n"
            "7. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ–ø–ª–∞—Ç–µ –∏ –∑–∞—Å–µ–ª–µ–Ω–∏—é;\n"
            "8. –í—Å–µ –∑–∞—è–≤–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ <b>–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</b>;\n"
            "9. –ò–∑ —Å–≤–æ–µ–π –∑–∞—è–≤–∫–∏ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å —á–∞—Ç —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º;\n"
            "10. –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏, –Ω–∞–ø–∏—à–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª /help."
        )
    },
    "info_object": {
        "title": "üè† *–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –æ–±—ä–µ–∫—Ç–∞:*",
        "body": (
            "1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª <b>–•–æ—á—É —Å–¥–∞–≤–∞—Ç—å –∂–∏–ª—å—ë</b>;\n"
            "2. –°–ª–µ–¥—É–π—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º —Ä–æ–±–æ—Ç–∞;\n"
            "3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ñ–æ—Ç–æ –∏ —Ç.–¥.;\n"
            "4. –ü—Ä–∏ –≤–≤–æ–¥–µ –∞–¥—Ä–µ—Å–∞ —É–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥, —É–ª–∏—Ü—É –∏ –Ω–æ–º–µ—Ä –¥–æ–º–∞;\n"
            "5. –í–Ω–∏–º–∞–Ω–∏–µ! –í –ø–æ–∏—Å–∫–æ–≤–æ–π –≤—ã–¥–∞—á–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –æ–¥–Ω–æ —Ñ–æ—Ç–æ - –ø–µ—Ä–≤–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ;\n"
            "6. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ;\n"
            "7. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –≤–∞—à –æ–±—ä–µ–∫—Ç –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ;\n"
            "8. –í —Ç–µ—á–µ–Ω–∏–µ —Å—É—Ç–æ–∫ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç–µ –µ–≥–æ;\n"
            "9. –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—è–≤–∏—Ç—Å—è —á–∞—Ç —Å –≤–∞–º–∏;\n"
            "10. –ü—Ä–æ–∏–Ω—Å—Ç—Ä—É–∫—Ç–∏—Ä—É–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –æ–ø–ª–∞—Ç–µ –∏ –∑–∞—Å–µ–ª–µ–Ω–∏—é –≤ —á–∞—Ç–µ;\n"
            "11. –í –±–ª–æ–∫–µ <b>–ú–æ–∏ –æ–±—ä–µ–∫—Ç—ã</> –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –≤–∞—à–∏ –æ–±—ä–µ–∫—Ç—ã –∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –Ω–∞ –Ω–∏—Ö –∑–∞—è–≤–∫–∏;\n"
            "12. –î–æ—Å—Ç—É–ø–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã. –î—Ä—É–≥–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É –∏–ª–∏ —á–µ—Ä–µ–∑ –£–¥–∞–ª–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ;\n"
            "13. –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏ ‚Äî –Ω–µ –¥–∞—Å—Ç —É–¥–∞–ª–∏—Ç—å, –ø–∏—à–∏—Ç–µ –≤ /help;\n"
            "14. –ß—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å –æ–±—ä–µ–∫—Ç –∏–∑ –ø–æ–∏—Å–∫–∞ –Ω–∞ –∑–∞–Ω—è—Ç—ã–µ –¥–∞—Ç—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <b>–ú–æ–∏ –û–±—ä–µ–∫—Ç—ã/–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–Ω—è—Ç–æ—Å—Ç–∏</b>;\n"
            "15. 25 —á–∏—Å–ª–∞ –º–µ—Å—è—Ü–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ –∫–æ–º–∏—Å—Å–∏–∏ –∑–∞ –±–æ—Ç–∞."
        )
    },
    "info_terms":{
        "title": "üìú *–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ EasySochi_rent_bot*",
        "body": (
                "1. EasySochi —è–≤–ª—è–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º (—á–∞—Ç-–±–æ—Ç–æ–º) –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å—Ç–æ—Ä–æ–Ω–æ–π —Å–¥–µ–ª–æ–∫ –∞—Ä–µ–Ω–¥—ã.\n"
                "2. –°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –¥–ª—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –º–µ–∂–¥—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞–º–∏ –∂–∏–ª—å—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞–º–∏).\n"
                "3. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–æ–ø–∏—Å–∞–Ω–∏—è, —Ñ–æ—Ç–æ, —Ü–µ–Ω—ã, —É—Å–ª–æ–≤–∏—è) –Ω–µ—Å—ë—Ç –ª–∏—Ü–æ, –µ—ë —Ä–∞–∑–º–µ—Å—Ç–∏–≤—à–µ–µ.\n"
                "4. –í—Å–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏ –ø–æ –∞—Ä–µ–Ω–¥–µ, –æ–ø–ª–∞—Ç–µ –∏ –∑–∞—Å–µ–ª–µ–Ω–∏—é –∑–∞–∫–ª—é—á–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –º–µ–∂–¥—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.\n"
                "5. EasySochi –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –∏ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ —Å—Ç–æ—Ä–æ–Ω.\n"
                "6. –°–µ—Ä–≤–∏—Å —Å—Ç—Ä–µ–º–∏—Ç—Å—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –±–µ—Å–ø–µ—Ä–µ–±–æ–π–Ω—É—é —Ä–∞–±–æ—Ç—É —á–∞—Ç-–±–æ—Ç–∞, –Ω–æ –Ω–µ –Ω–µ—Å—ë—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ø–µ—Ä–µ–±–æ–∏ —Å–≤—è–∑–∏ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram.\n"
                "7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç —Å–≤–æ–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–æ–≤ –∏ –∏–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ.\n"
                "8. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –æ–±—ä—ë–º–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–º –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ø–æ–∏—Å–∫, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è).\n"
                "9. EasySochi –æ–±—è–∑—É–µ—Ç—Å—è –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º, –∫—Ä–æ–º–µ —Å–ª—É—á–∞–µ–≤, –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞–∫–æ–Ω–æ–º.\n"
                "10. –ò—Å–ø–æ–ª—å–∑—É—è —Å–µ—Ä–≤–∏—Å, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω —Å –¥–∞–Ω–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ –∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏—Ö.\n"

        )
    }
}
INFO_HANDLER = 1

async def info_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await cleanup_messages(context)
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Å–ø—Ä–∞–≤–∫–∏. –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –ø—Ä–∏ –ø—Ä—è–º–æ–º –≤—ã–∑–æ–≤–µ /info, —Ç–∞–∫ –∏ –ø—Ä–∏ callback.
    """
    text = "‚ÑπÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é:"
    keyboard = [
        [InlineKeyboardButton("üë• –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞–º", callback_data="info_booking"),
         InlineKeyboardButton("–ü—Ä–∞–≤–∏–ª–∞ —Å–µ—Ä–≤–∏—Å–∞ üìú", callback_data="info_terms")],
        [InlineKeyboardButton("üè† –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞–º", callback_data="info_object"),
         InlineKeyboardButton("–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚û°Ô∏è", callback_data="back_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    msg = await send_message(update,text, reply_markup=reply_markup)
    await add_message_to_cleanup(context,msg.chat_id,msg.message_id)
    return INFO_HANDLER

async def show_info_text(update_or_query: Update, context: ContextTypes.DEFAULT_TYPE, key: str,):
    """
    –í—ã–≤–æ–¥–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ –∫–ª—é—á—É. –†–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –∏ –¥–ª—è callback.
    –ö–Ω–æ–ø–∫–∞ '–ù–∞–∑–∞–¥ –≤ –∏–Ω—Ñ–æ' –∏–º–µ–µ—Ç callback_data='help_menu'.
    """
    data = INFO_TEXTS.get(key)
    if not data:
        return

    text = f"{data['title']}\n\n{data['body']}"
    markup = [
        [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –ò–Ω—Ñ–æ", callback_data="info_menu"),
         InlineKeyboardButton("–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚û°Ô∏è", callback_data="back_menu")]
    ]

    message = await send_message(update_or_query,text,reply_markup=InlineKeyboardMarkup(markup),parse_mode="HTML")
    if not message:
        return
    await add_message_to_cleanup(context,message.chat_id,message.message_id)



async def info_callback_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback'–æ–≤ –¥–ª—è help_*
    - –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ query (query.answer()) —Ç–æ–ª—å–∫–æ –¥–ª—è callback'–æ–≤ info_*
    - –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö callback'–æ–≤ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∞–ø–¥–µ–π—Ç –¥–∞–ª—å—à–µ
    """
    query = update.callback_query
    if not query:
        return ConversationHandler.SKIP  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–ø–¥–µ–π—Ç –¥–ª—è MessageHandler

    data = query.data or ""
    if data == "back_menu":
        await query.answer()
        return ConversationHandler.END

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ callback'—ã, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ info
    if data.startswith("info_"):
        await query.answer()  # —É–±–∏—Ä–∞–µ–º –∫—Ä—É—Ç–∏–ª–∫—É –≤ UI
        try:
            # –≠—Ç–æ —É–¥–∞–ª–∏—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ–¥ –∏—Å—Ö–æ–¥–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            await query.edit_message_reply_markup(reply_markup=None)
        except BadRequest as e:
            # –Ω–∞–ø—Ä–∏–º–µ—Ä: —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ ‚Äî –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º
            logging.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —É–±—Ä–∞—Ç—å inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É: %s", e)

        if data == "info_booking":
            await show_info_text(update, context, "info_booking")
        elif data == "info_object":
            await show_info_text(update, context, "info_object")
        elif data == "info_terms":
            await show_info_text(update, context, "info_terms")
        elif data == "info_menu":
            await info_command(update, context)

            

        # –ï—Å–ª–∏ –º—ã –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ callback ‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
        return INFO_HANDLER
    
async def help_and_end(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ó–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç info_command."""
    await cleanup_messages(context)
    await start_problem(update, context)
    return ConversationHandler.END

async def invite_and_end(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ó–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç info_command."""
    await cleanup_messages(context)
    await start_invite(update, context)
    return ConversationHandler.END



async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "‚ùå –í—ã—Ö–æ–¥ –∏–∑ –±–ª–æ–∫–∞ –ò–Ω—Ñ–æ.",
        reply_markup=None
    )
    context.user_data.clear()
    return ConversationHandler.END